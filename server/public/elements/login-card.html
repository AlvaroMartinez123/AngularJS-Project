<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/core-item/core-item.html">

<polymer-element name="login-card" attributes="showRegistered, logged">
<template>
<style>
  #core_card {
  position: relative;
  width: 100%;
  height: auto;
  border:1px solid #191919;
  box-shadow: 0 5px 10px 5px rgba(0,0,0,0.2);
  color:white;
  background:#333 ;
  z-index: 1;
    border-bottom-right-radius: 5px;
  border-bottom-left-radius: 5px;

  /*opacity: .95;*/
}
  #register p {
  font-size: 100%;
  margin-left: 5px;
  font-weight: bold
}
#register {
  background:#1C1C1C;
  border-bottom-style: solid;
  border-bottom-color: white;
  border-bottom-width: 1px;
  
}
#container {
  width: 90%;
  height: auto;
  margin: 0px auto;
  text-align: center;
}
#paper_button {
  text-align: center;
  margin: 20px;
}
paper-input {
  margin-left: auto;
  margin-right: auto;
  width: 200px;
}
#facebook {
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: rgb(219, 224, 226);
}
#paper_button2{
  width:90%;
  margin-top: 20px;
  margin-bottom: 20px;
  position: relative;
  border:1px solid rgba(0,0,0,0.4);
  text-shadow:0 -1px 0 rgba(0,0,0,0.4);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.3),
    inset 0 10px 10px rgba(255,255,255,0.1);
  border-radius:0.3em;
  background:#0184ff;
  color:white;
  font-weight:bold;
  cursor:pointer;
  font-size:13px;
}
 #registered_card {
  position: absolute;
  width: 400px;
  height: 150px;
  border-radius-bottom:0.4em;
  border:1px solid #191919;
  box-shadow: 0 5px 10px 5px rgba(0,0,0,0.2);
  color:white;
  background:#333 ;


  /*opacity: .95;*/
}
#return{
  width:200px;
  position: relative;
  border:1px solid rgba(0,0,0,0.4);
  text-shadow:0 -1px 0 rgba(0,0,0,0.4);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.3),
    inset 0 10px 10px rgba(255,255,255,0.1);
  border-radius:0.3em;
  background:#0184ff;
  color:white;
  font-weight:bold;
  cursor:pointer;
  font-size:13px;
}
#sectionp {
  width: 420px;
  height: 100%;
  position: relative;
}
#paper_tabs {
  background:#1C1C1C;
  border-bottom-style: solid;
  border-bottom-color: white;
  border-bottom-width: 1px;
  font-size: 100%;
  font-weight: bold;
  color: white;
  width: 100%;
  border-top-right-radius: 5px;
  border-top-left-radius: 5px;
}
#section1 {
  height: auto;

}
#core_animated_pages {
  width: 100%;
  height: auto;
  position: relative;
  background-color: rgb(238, 238, 238);
  border-bottom-right-radius: 5px;
  border-bottom-left-radius: 5px;
}

#section2 {
  height: auto;
  position: relative;
}
#section3 {
  height: auto;
  position: relative;
}
#p3{
  border-bottom: 1px solid white;
  padding-bottom: 10px;
}

     #signout {
       color: white;
       background-color: rgba(170,0,0,0.40);
       border-radius: 5px;
     }

     #signout::shadow core-icon div {
       border-radius: 50%;
     }
     #signin {
      display: inline-block;
      background: #cc3732;
      color: white;
      width: 175px;
      border-radius: 5px;
    }
    #signin:hover {
      background: #e74b37;
      cursor: hand;
    }
    #signin.label {
      font-weight: bold;
    }
    
    #signin.buttonText {
      display: inline-block;
      vertical-align: middle;
      padding-left: 40px;
      padding-right: 40px;
    }
</style>
<app-login id="login"></app-login>
<div center-justified horizontal layout center>
<section id="sectionp" >
    <paper-tabs noink nobar hidden?="{{showRegistered}}" selected="0" selectedindex="0" id="paper_tabs" horizontal center layout>
      <paper-tab id="paper_tab" inline flex center-center horizontal layout active>REGISTER</paper-tab>
      <paper-tab id="paper_tab1" inline flex center-center horizontal layout>LOGIN</paper-tab>
    </paper-tabs>
    <section id="section1" flex relative>
      <core-animated-pages selected="{{ $.paper_tabs.selected }}" lastselected="0" selectedindex="0" notap id="core_animated_pages">
          <section id="section2" layout horizontal center center-justified active>
            <core-card id="core_card" layout vertical hidden?="{{showRegistered}}">
              <div id="container">
                <div id="form">
                  <p id="p3">Create your account</p>
                  <paper-input label="Username"  id="username" floatinglabel  layout vertical error="Username required" required></paper-input>
                  <paper-input  label="Password" type="password" floatinglabel   id="password" layout vertical error="Password required" required></paper-input>
                  <paper-input label="Email" id="email" floatinglabel error="Email required" layout vertical required></paper-input>
                  <paper-button label="Register" on-tap={{handleRegister}} id="paper_button2"></paper-button>

                </div>
              </div>
            </core-card>
          </section>
          <section id="section3"  layout horizontal center center-justified active>
            <core-card id="core_card" layout vertical hidden?="{{showRegistered}}">
              <div id="container">
                <paper-item id="signin" label="Sign In" on-click="{{fireLogin}}" hidden?="{{logged}}" icon="account-circle"></paper-item>
                <core-item id="signout" src="{{photoUrl}}" label="Sign Out" on-click="{{fireLogout}}"  hidden?="{{!logged}}"></core-item>
                <div id="form">
                  <p id="p1">Login</p>
                  <paper-input label="Username"  id="username_login" floatinglabel  layout vertical error="Valid username required" required></paper-input>
                  <paper-input  label="Password" type="password" floatinglabel   id="password_login" layout vertical error="Valid password required" required></paper-input>
                  <paper-button label="Login" id="paper_button2"></paper-button>

                </div>
              </div>
            </core-card>
          </section>
      </core-animated-pages>
    </section>
</section>
</div>
  <core-card id="registered_card" layout vertical hidden?="{{!showRegistered}}">
    <div id="register" start-justified horizontal layout start>
      <p id="p">REGISTERED</p>
    </div>
    <div id="container">
    <p>Welcome to Rapidshot!</p>
    <paper-button label="Return" on-tap={{handleReturn}} id="return"></paper-button>
    </div>
  </core-card>
  <paper-toast id="fill" text="Fill all the fields"></paper-toast>
</template>

<script>
function doAjax(options, success, error) {
  var deferred = $.Deferred();
  var self = this;
  options.type = options.type || 'GET';
  options.url = options.url || '';
  if (socket.io.engine.id) {
    options.url += '?socketId=' + socket.io.engine.id;
  }
  options.dataType = options.dataType || 'json';
  options.contentType = options.contentType || 'application/json; charset=UTF-8';
  options.success = success;
  options.error = (typeof error === 'function');
  options.cache = false;
  options.async = true;

  options.beforeSend = function(xhr) {
    xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token);
  };

  $.ajax(options).done(function(data) {
    deferred.resolve(data);
  }).fail(function(jqXHR, textStatus, errorThrown) {
    var err = '[doAjax] ERROR[' + jqXHR.status + '] textStatus[' + textStatus + '] errorThrown[' + errorThrown + ']';
    console.log(err);
    deferred.reject(err);
  });


  return deferred.promise();
     };



var socket = (function() {
  var sock;
  var events = [];
  return {
    connect: function(token) {
      if (!sock) {
        sock = io.connect(':9001/', {
          query: 'token=' + token
        });
        sock.on('connect', function() {
          console.log('authenticated');
          events.forEach(function(fn) {
            fn.call(sock);
          });
        }).on('disconnect', function() {
          console.log('disconnected');
        });
      } else {
        sock.connect();
      }
    },
    disconnect: function() {
      sock.disconnect();
    },
    id: function() {
      if (sock) {
        return sock.io.engine.id;
      }
    },
    addEvent: function(fn) {
      events.push(fn);
    }
  };
}());



var getProfile = (function() {
  var profile = null;

  return function() {
    var deferred = $.Deferred();

    if (profile) {

      return deferred.resolve(profile);
    } else {


      doAjax({url: '/photo/profile'}).done(function(user) {

        profile = user;
        deferred.resolve(profile);
      }).fail(function(jqXHR, textStatus, errorThrown) {
        var err = '[doAjax] ERROR[' + jqXHR.status + '] textStatus[' + textStatus + '] errorThrown[' + errorThrown + ']';
        console.log(err);
        deferred.reject(err);
      });
    }
    return deferred.promise();
  };
}());

var users;
Polymer('login-card', {
        ready: function() {
        this.a="";
        this.b="";
      },
  showRegistered : false,
  validate: function(){
    var name = this.$.username.value;
    var password = this.$.password.value;
    var email = this.$.email.value;

    if(name === "" || password === "" || email === ""){
      return false;
    }else{
      return true;
    }
  },
  handleRegister: function(){
    if(this.validate()){
      var name = this.$.username.value;
      var password = this.$.password.value;
      var email = this.$.email.value;

        this.newUser(name, password, email);
        this.showRegistered = !this.showRegistered;
        
      this.$.username.value = "";
      this.$.password.value = "";
      this.$.email.value = "";
    }else{
      this.$.fill.show();
    }
  },
  handleReturn: function(){
      this.showRegistered = !this.showRegistered;
    },
    created: function() {
     if (!users) {
       doAjax({url:'/user'}, function(data) {
         users = data;
         this.users = users;
       }.bind(this));
     }
   },
  newUser: function(name, password, email) {
    var data = {
      name:name,
      password:password,
      email:email
    }
    doAjax({type: 'POST', url:'/user/', data:JSON.stringify(data)}, function(result){
      this.users.push(result);
    }.bind(this));
  },
  setUser: function(user, name){
    var data = {
      name:name,
      password:user.password,
      email:user.email,
      score:user.score
    }

    console.log(user._id);

    var url = '/' + user._id;
    doAjax({type: 'PUT', url:url, data:JSON.stringify(data)}, function(result){
      user.name = name;

    }.bind(this));
  },
  deleteUser: function(user) {
    var url = '/' + user._id;
    doAjax({type: 'DELETE', url:url}, function(result){
      var i = this.users.indexOf(user);
      if(i >= 0){
        this.scores.splice(i, 1);
      }
    }.bind(this));
  },
    fireLogin: function() {
      this.fire('login');
    },
    fireLogout: function() {
      this.fire('logout');
    },
    loggedChanged: function() {
      if (this.logged) {
        getProfile().done(function(user) {
          this.photoUrl = user._json.picture;
        }.bind(this)).fail(function() {
          this.photoUrl = '';
        }.bind(this));
      }
    }

  });
</script>

</polymer-element>